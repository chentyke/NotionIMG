<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEICå›¾ç‰‡è½¬æ¢æµ‹è¯•</title>
    <link rel="stylesheet" href="css/images.css">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f8fafc;
            line-height: 1.6;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .success-banner {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 3rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .console-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-radius: 4px;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #60a5fa; }
        .test-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-button.success {
            background: #10b981;
        }
        .test-button.success:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ–¼ï¸ HEICå›¾ç‰‡è½¬æ¢ç³»ç»Ÿ</h1>
        
        <div class="success-banner">
            <strong>âœ… ç³»ç»Ÿå°±ç»ª:</strong> HEICè½¬æ¢åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²å¹¶æµ‹è¯•é€šè¿‡ï¼æ”¯æŒè‡ªåŠ¨æ£€æµ‹ã€æœåŠ¡å™¨ç«¯ä»£ç†å’Œé«˜æ•ˆå‹ç¼©ã€‚
        </div>
        
        <!-- æµ‹è¯•éƒ¨åˆ†1: æµè§ˆå™¨æ”¯æŒæ£€æµ‹ -->
        <div class="test-section">
            <h2>ğŸ” æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹</h2>
            <div class="test-controls">
                <button class="test-button" onclick="testBrowserSupport()">æ£€æµ‹HEICæ”¯æŒ</button>
                <button class="test-button" onclick="testLibraryLoading()">æµ‹è¯•è½¬æ¢åº“</button>
            </div>
            <div id="support-results"></div>
        </div>
        
        <!-- æµ‹è¯•éƒ¨åˆ†2: å®é™…HEICæ–‡ä»¶æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ¯ HEICæ–‡ä»¶è½¬æ¢æµ‹è¯•</h2>
            <div style="margin-bottom: 1rem;">
                <label for="heic-url" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">è¾“å…¥HEICå›¾ç‰‡URL:</label>
                <input type="url" 
                       id="heic-url" 
                       placeholder="https://example.com/image.heic"
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
            </div>
            <div class="test-controls">
                <button class="test-button" onclick="testCustomHeicUrl()">æµ‹è¯•è¿™ä¸ªURL</button>
                <button class="test-button success" onclick="testNotionHeicUrl()">æµ‹è¯•å·²éªŒè¯çš„HEIC</button>
                <button class="test-button" onclick="clearTestArea()">æ¸…é™¤æµ‹è¯•åŒºåŸŸ</button>
            </div>
            <div id="custom-test-area" style="margin-top: 1rem; min-height: 200px; border: 2px dashed #d1d5db; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                ç‚¹å‡»"æµ‹è¯•å·²éªŒè¯çš„HEIC"æ¥åŠ è½½ç»è¿‡éªŒè¯çš„HEICå›¾ç‰‡
            </div>
        </div>
        
        <!-- è¯¦ç»†è°ƒè¯•æµ‹è¯•ï¼ˆä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼‰ -->
        <div class="test-section">
            <h2>ğŸ”§ ç³»ç»Ÿè¯Šæ–­</h2>
            <p>æµ‹è¯•æœåŠ¡å™¨ä»£ç†å’Œè½¬æ¢æµç¨‹</p>
            <div class="test-controls">
                <button class="test-button" onclick="testServerProxy()">æµ‹è¯•æœåŠ¡å™¨ä»£ç†</button>
                <button class="test-button" onclick="testDirectConversion()">æµ‹è¯•ç›´æ¥è½¬æ¢</button>
            </div>
            <div id="debug-results" style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                <h4>è¯Šæ–­ç»“æœ:</h4>
                <div id="debug-output">ç­‰å¾…è¯Šæ–­æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- æ§åˆ¶å°è¾“å‡ºï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
        <div class="test-section">
            <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="console-output" id="consoleOutput">
                <div class="log-entry log-info">[ç³»ç»Ÿå·²å°±ç»ª]</div>
            </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
            <h3>ç³»ç»Ÿç‰¹æ€§:</h3>
            <ul>
                <li>ğŸš€ <strong>è‡ªåŠ¨æ£€æµ‹:</strong> è‡ªåŠ¨è¯†åˆ«HEICå›¾ç‰‡å¹¶è¿›è¡Œè½¬æ¢</li>
                <li>ğŸŒ <strong>æœåŠ¡å™¨ä»£ç†:</strong> è§£å†³CORSé™åˆ¶ï¼Œç¡®ä¿å¯é çš„æ–‡ä»¶è·å–</li>
                <li>âš¡ <strong>æ™ºèƒ½ä¼˜åŒ–:</strong> é«˜è´¨é‡å‹ç¼©ï¼Œå‡å°‘æ–‡ä»¶å¤§å°</li>
                <li>ğŸ”„ <strong>å…¼å®¹æ€§:</strong> æ”¯æŒæ‰€æœ‰ä¸»æµæµè§ˆå™¨</li>
                <li>ğŸ’¾ <strong>ç¼“å­˜æœºåˆ¶:</strong> é¿å…é‡å¤è½¬æ¢ï¼Œæå‡æ€§èƒ½</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initImageObserver } from './js/modules/imageHandler.js';
        import { 
            checkHEICSupport, 
            isHEICImage, 
            loadHeic2AnyLibrary,
            convertHEICImage,
            smartImageLoader 
        } from './js/modules/heicConverter.js';
        
        // ç®€åŒ–çš„æ§åˆ¶å°è¾“å‡º
        const consoleOutput = document.getElementById('consoleOutput');
        let logCount = 0;
        const MAX_LOGS = 20;
        
        function addConsoleEntry(message, type = 'info') {
            if (logCount >= MAX_LOGS) {
                consoleOutput.innerHTML = '<div class="log-entry log-info">[æ—¥å¿—å·²æ¸…ç†...]</div>';
                logCount = 1;
            }
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            logCount++;
        }
        
        // é‡å†™æ§åˆ¶å°æ–¹æ³•ï¼ˆåªæ•è·é‡è¦ä¿¡æ¯ï¼‰
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('âœ…') || message.includes('ğŸ“¦') || message.includes('ğŸš€')) {
                addConsoleEntry(message, 'success');
            }
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.join(' ');
            if (!message.includes('net::ERR_FAILED') && !message.includes('400')) {
                addConsoleEntry(message, 'error');
            }
            originalError.apply(console, args);
        };
        
        // æµ‹è¯•å‡½æ•°
        window.testBrowserSupport = async function() {
            addConsoleEntry('æ£€æµ‹æµè§ˆå™¨HEICæ”¯æŒ...', 'info');
            
            try {
                const supported = await checkHEICSupport();
                const resultsDiv = document.getElementById('support-results');
                
                if (supported) {
                    resultsDiv.innerHTML = `
                        <div style="background: #d1fae5; border: 1px solid #10b981; color: #065f46; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            âœ… <strong>æ‚¨çš„æµè§ˆå™¨åŸç”Ÿæ”¯æŒHEICæ ¼å¼</strong>
                        </div>
                    `;
                    addConsoleEntry('âœ… æµè§ˆå™¨åŸç”Ÿæ”¯æŒHEIC', 'success');
                } else {
                    resultsDiv.innerHTML = `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            âš ï¸ <strong>éœ€è¦è½¬æ¢HEICæ ¼å¼</strong><br>
                            <small>ç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢HEICå›¾ç‰‡ä¸ºJPEGæ ¼å¼</small>
                        </div>
                    `;
                    addConsoleEntry('âš ï¸ éœ€è¦HEICè½¬æ¢', 'warning');
                }
            } catch (error) {
                addConsoleEntry(`âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        };
        
        window.testLibraryLoading = async function() {
            addConsoleEntry('æµ‹è¯•è½¬æ¢åº“åŠ è½½...', 'info');
            
            try {
                await loadHeic2AnyLibrary();
                addConsoleEntry('âœ… è½¬æ¢åº“åŠ è½½æˆåŠŸ', 'success');
                
                const resultsDiv = document.getElementById('support-results');
                resultsDiv.innerHTML += `
                    <div style="background: #d1fae5; border: 1px solid #10b981; color: #065f46; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                        âœ… <strong>HEICè½¬æ¢åº“å·²å°±ç»ª</strong>
                    </div>
                `;
            } catch (error) {
                addConsoleEntry(`âŒ è½¬æ¢åº“åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        };
        
        window.testCustomHeicUrl = function() {
            const url = document.getElementById('heic-url').value.trim();
            if (!url) {
                addConsoleEntry('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„URL', 'error');
                return;
            }
            
            if (!isHEICImage(url)) {
                addConsoleEntry('âš ï¸ URLå¯èƒ½ä¸æ˜¯HEICæ ¼å¼', 'warning');
            }
            
            addConsoleEntry(`å¼€å§‹æµ‹è¯•: ${url}`, 'info');
            
            const testArea = document.getElementById('custom-test-area');
            testArea.innerHTML = `
                <figure class="image-container" style="width: 100%;">
                    <div class="image-wrapper">
                        <img src="" 
                             data-src="${url}" 
                             alt="Custom HEIC test" 
                             class="rounded-lg shadow-md opacity-0 transition-all duration-300 ease-out"
                             loading="lazy"
                             style="max-width: 100%; height: auto;">
                    </div>
                    <figcaption class="text-center text-sm text-gray-500 mt-2">æµ‹è¯•å›¾ç‰‡: ${url}</figcaption>
                </figure>
            `;
            
            initImageObserver();
        };
        
        window.testNotionHeicUrl = function() {
            const notionUrl = 'https://file.notion.so/f/f/45e9d135-9939-47d9-9926-65d8fce8f56e/8c7d6cb9-b06e-4363-8ce9-5d2a39bb38c0/67A01614.heic?table=block&id=1946e0f1-7397-8086-82be-d3a9ccbf6e7d&spaceId=45e9d135-9939-47d9-9926-65d8fce8f56e&expirationTimestamp=1748203200000&signature=QghDzXpwITiDv6RZEJACL9yLN7XTow9NrdO78egrfSU&download=true&downloadName=67A01614.heic';
            
            addConsoleEntry('ğŸ” æµ‹è¯•å·²éªŒè¯çš„Notion HEIC...', 'info');
            document.getElementById('heic-url').value = notionUrl;
            testCustomHeicUrl();
        };
        
        window.clearTestArea = function() {
            const testArea = document.getElementById('custom-test-area');
            testArea.innerHTML = 'ç‚¹å‡»"æµ‹è¯•å·²éªŒè¯çš„HEIC"æ¥åŠ è½½ç»è¿‡éªŒè¯çš„HEICå›¾ç‰‡';
            testArea.style.cssText = 'margin-top: 1rem; min-height: 200px; border: 2px dashed #d1d5db; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280;';
            addConsoleEntry('ğŸ§¹ æµ‹è¯•åŒºåŸŸå·²æ¸…é™¤', 'info');
        };
        
        window.testServerProxy = async function() {
            const url = 'https://file.notion.so/f/f/45e9d135-9939-47d9-9926-65d8fce8f56e/8c7d6cb9-b06e-4363-8ce9-5d2a39bb38c0/67A01614.heic?table=block&id=1946e0f1-7397-8086-82be-d3a9ccbf6e7d&spaceId=45e9d135-9939-47d9-9926-65d8fce8f56e&expirationTimestamp=1748203200000&signature=QghDzXpwITiDv6RZEJACL9yLN7XTow9NrdO78egrfSU&download=true&downloadName=67A01614.heic';
            const debugOutput = document.getElementById('debug-output');
            
            addConsoleEntry('ğŸŒ æµ‹è¯•æœåŠ¡å™¨ä»£ç†...', 'info');
            
            try {
                const proxyUrl = `/api/proxy/heic?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (response.ok) {
                    const arrayBuffer = await response.arrayBuffer();
                    const sizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(2);
                    
                    addConsoleEntry(`âœ… æœåŠ¡å™¨ä»£ç†æˆåŠŸ: ${sizeMB}MB`, 'success');
                    debugOutput.innerHTML = `
                        <div style="color: #10b981;">âœ… æœåŠ¡å™¨ä»£ç†æ­£å¸¸å·¥ä½œ</div>
                        <div>ğŸ“Š æ–‡ä»¶å¤§å°: ${sizeMB}MB</div>
                        <div>ğŸŒ ä»£ç†URL: ${proxyUrl}</div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addConsoleEntry(`âŒ æœåŠ¡å™¨ä»£ç†å¤±è´¥: ${error.message}`, 'error');
                debugOutput.innerHTML = `<div style="color: #ef4444;">âŒ ä»£ç†å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        window.testDirectConversion = async function() {
            const url = 'https://file.notion.so/f/f/45e9d135-9939-47d9-9926-65d8fce8f56e/8c7d6cb9-b06e-4363-8ce9-5d2a39bb38c0/67A01614.heic?table=block&id=1946e0f1-7397-8086-82be-d3a9ccbf6e7d&spaceId=45e9d135-9939-47d9-9926-65d8fce8f56e&expirationTimestamp=1748203200000&signature=QghDzXpwITiDv6RZEJACL9yLN7XTow9NrdO78egrfSU&download=true&downloadName=67A01614.heic';
            const debugOutput = document.getElementById('debug-output');
            
            addConsoleEntry('ğŸ”„ æµ‹è¯•ç›´æ¥è½¬æ¢...', 'info');
            
            try {
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'position: relative; width: 300px; height: 200px; border: 1px solid #ccc; margin: 1rem 0;';
                
                const convertedUrl = await convertHEICImage(url, wrapper, {
                    quality: 0.85,
                    maxWidth: 1920,
                    maxHeight: 1080
                });
                
                addConsoleEntry(`âœ… ç›´æ¥è½¬æ¢æˆåŠŸ`, 'success');
                debugOutput.innerHTML = `
                    <div style="color: #10b981;">âœ… è½¬æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ</div>
                    <div>ğŸ¯ è½¬æ¢ç»“æœ: ${convertedUrl ? 'Blob URLç”ŸæˆæˆåŠŸ' : 'è½¬æ¢å¤±è´¥'}</div>
                `;
                
            } catch (error) {
                addConsoleEntry(`âŒ ç›´æ¥è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                debugOutput.innerHTML = `<div style="color: #ef4444;">âŒ è½¬æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        addConsoleEntry('ğŸš€ HEICè½¬æ¢ç³»ç»Ÿå·²å°±ç»ª', 'success');
        
        try {
            initImageObserver();
            addConsoleEntry('âœ… å›¾ç‰‡è§‚å¯Ÿå™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
        } catch (error) {
            addConsoleEntry(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        }
        
        // è‡ªåŠ¨è¿è¡Œå…¼å®¹æ€§æ£€æµ‹
        setTimeout(() => {
            testBrowserSupport();
        }, 2000);
    </script>
</body>
</html> 