<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片加载修复测试</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 40px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-line;
            margin: 10px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>图片加载修复测试</h1>
    
    <div class="test-section">
        <h2>测试1: imageObserver正常工作</h2>
        <p>测试IntersectionObserver是否正确初始化和观察图片元素</p>
        <div id="observer-test-log" class="log">测试开始...</div>
        <div id="observer-test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2: HEIC格式错误处理</h2>
        <p>测试HEIC格式图片的错误处理是否正确显示</p>
        <div class="image-wrapper">
            <img src="" data-src="https://example.com/test.heic" alt="HEIC测试图片" class="test-image">
        </div>
        <div id="heic-test-log" class="log">等待测试...</div>
    </div>
    
    <div class="test-section">
        <h2>测试3: AWS链接过期处理</h2>
        <p>测试过期的AWS S3链接错误处理</p>
        <div class="image-wrapper">
            <img src="" data-src="https://prod-files-secure.s3.us-west-2.amazonaws.com/expired.jpg?X-Amz-Expires=3600" alt="过期链接测试" class="test-image">
        </div>
        <div id="aws-test-log" class="log">等待测试...</div>
    </div>
    
    <div class="test-section">
        <h2>测试4: 正常图片加载</h2>
        <p>测试正常图片是否能正确加载</p>
        <div class="image-wrapper">
            <img src="" data-src="https://picsum.photos/400/300" alt="正常图片测试" class="test-image">
        </div>
        <div id="normal-test-log" class="log">等待测试...</div>
    </div>

    <script type="module">
        // 模拟修复后的imageHandler模块
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        loadImageWithAnimation(img);
                        observer.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '100px 0px',
            threshold: 0.1
        });

        async function loadImageWithAnimation(img) {
            try {
                const wrapper = img.closest('.image-wrapper');
                if (wrapper) {
                    wrapper.classList.add('loading');
                }

                const preloadImg = new Image();
                preloadImg.crossOrigin = "anonymous";
                
                preloadImg.onload = () => {
                    displayImage(img, preloadImg.src, wrapper);
                    logTest(getTestId(img), `✓ 图片加载成功: ${img.dataset.src}`, 'success');
                };

                preloadImg.onerror = () => {
                    handleImageError(img, wrapper, preloadImg.src);
                };

                preloadImg.src = img.dataset.src;

            } catch (error) {
                console.error('Error loading image:', error);
                handleImageError(img, img.closest('.image-wrapper'), img.dataset.src);
            }
        }

        function displayImage(img, src, wrapper) {
            img.src = src;
            img.classList.add('loaded');
            
            if (wrapper) {
                wrapper.classList.remove('loading');
                wrapper.classList.add('loaded');
            }
        }

        function handleImageError(img, wrapper, failedSrc = '') {
            const originalSrc = img.dataset.src || failedSrc;
            console.error('Failed to load image:', originalSrc);
            
            const isHeicFormat = originalSrc.toLowerCase().includes('.heic');
            const isNotionImage = originalSrc.includes('prod-files-secure.s3.us-west-2.amazonaws.com');
            
            if (wrapper) {
                wrapper.classList.remove('loading');
                
                let errorMessage = 'Failed to load image';
                let showRetry = true;
                
                if (isHeicFormat) {
                    errorMessage = 'HEIC format not supported by browser';
                    showRetry = false;
                    logTest('heic', `✓ HEIC格式错误正确识别`, 'success');
                } else if (isNotionImage && originalSrc.includes('X-Amz-Expires')) {
                    errorMessage = 'Image link expired - please refresh the page';
                    showRetry = false;
                    logTest('aws', `✓ AWS过期链接正确识别`, 'success');
                } else {
                    logTest(getTestId(img), `✗ 图片加载失败: ${originalSrc}`, 'error');
                }
                
                wrapper.innerHTML = `
                    <div class="image-error" style="text-align: center; padding: 20px; background: #f5f5f5; border: 2px dashed #ccc; border-radius: 8px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">📷</div>
                        <div style="color: #666; margin-bottom: 10px;">${errorMessage}</div>
                        ${isHeicFormat ? `
                            <div style="font-size: 0.875rem; color: #888; margin-bottom: 10px;">
                                HEIC images are not supported in web browsers.<br>
                                Please convert to JPG, PNG, or WebP format.
                            </div>
                        ` : ''}
                        ${showRetry ? `
                            <button onclick="retryImageLoad(this)" 
                                    style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Retry
                            </button>
                        ` : isNotionImage ? `
                            <button onclick="window.location.reload()" 
                                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Refresh Page
                            </button>
                        ` : ''}
                        <div style="font-size: 0.75rem; color: #999; margin-top: 10px; word-break: break-all;">${originalSrc}</div>
                    </div>
                `;
            }
        }

        function getTestId(img) {
            if (img.dataset.src.includes('.heic')) return 'heic';
            if (img.dataset.src.includes('X-Amz-Expires')) return 'aws';
            if (img.dataset.src.includes('picsum.photos')) return 'normal';
            return 'unknown';
        }

        function logTest(testId, message, type = 'info') {
            const logElement = document.getElementById(`${testId}-test-log`);
            if (logElement) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `\n[${timestamp}] ${message}`;
                logElement.className = `log ${type}`;
            }
        }

        // 测试1: 验证imageObserver正常工作
        function testImageObserver() {
            try {
                const images = document.querySelectorAll('img[data-src]');
                logTest('observer', `找到 ${images.length} 个需要观察的图片`, 'info');
                
                // 修复后的正确方式
                images.forEach(img => {
                    imageObserver.observe(img);
                });
                
                logTest('observer', `✓ imageObserver.observe() 调用成功`, 'success');
                logTest('observer', `✓ 已为 ${images.length} 个图片设置懒加载观察`, 'success');
                
                // 测试错误的调用方式（应该失败）
                try {
                    imageObserver.init();
                    logTest('observer', `✗ imageObserver.init() 不应该成功`, 'error');
                } catch (error) {
                    logTest('observer', `✓ imageObserver.init() 正确抛出错误: ${error.message}`, 'success');
                }
                
            } catch (error) {
                logTest('observer', `✗ imageObserver测试失败: ${error.message}`, 'error');
            }
        }

        // 全局重试函数
        window.retryImageLoad = function(button) {
            const wrapper = button.closest('.image-wrapper');
            if (!wrapper) return;
            
            const img = wrapper.querySelector('img');
            if (!img || !img.dataset.src) return;
            
            wrapper.classList.remove('loaded');
            wrapper.classList.add('loading');
            wrapper.innerHTML = '<img src="" alt="" style="opacity: 0;">';
            
            const newImg = wrapper.querySelector('img');
            newImg.dataset.src = img.dataset.src;
            newImg.alt = img.alt;
            
            loadImageWithAnimation(newImg);
        };

        // 启动测试
        document.addEventListener('DOMContentLoaded', function() {
            logTest('observer', '开始测试imageObserver功能...', 'info');
            testImageObserver();
            
            // 给图片一些时间加载
            setTimeout(() => {
                logTest('heic', '开始测试HEIC格式错误处理...', 'info');
                logTest('aws', '开始测试AWS过期链接处理...', 'info');
                logTest('normal', '开始测试正常图片加载...', 'info');
            }, 1000);
        });
    </script>
</body>
</html> 