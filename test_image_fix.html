<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åŠ è½½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 40px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-line;
            margin: 10px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>å›¾ç‰‡åŠ è½½ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1: imageObserveræ­£å¸¸å·¥ä½œ</h2>
        <p>æµ‹è¯•IntersectionObserveræ˜¯å¦æ­£ç¡®åˆå§‹åŒ–å’Œè§‚å¯Ÿå›¾ç‰‡å…ƒç´ </p>
        <div id="observer-test-log" class="log">æµ‹è¯•å¼€å§‹...</div>
        <div id="observer-test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2: HEICæ ¼å¼é”™è¯¯å¤„ç†</h2>
        <p>æµ‹è¯•HEICæ ¼å¼å›¾ç‰‡çš„é”™è¯¯å¤„ç†æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</p>
        <div class="image-wrapper">
            <img src="" data-src="https://example.com/test.heic" alt="HEICæµ‹è¯•å›¾ç‰‡" class="test-image">
        </div>
        <div id="heic-test-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3: AWSé“¾æ¥è¿‡æœŸå¤„ç†</h2>
        <p>æµ‹è¯•è¿‡æœŸçš„AWS S3é“¾æ¥é”™è¯¯å¤„ç†</p>
        <div class="image-wrapper">
            <img src="" data-src="https://prod-files-secure.s3.us-west-2.amazonaws.com/expired.jpg?X-Amz-Expires=3600" alt="è¿‡æœŸé“¾æ¥æµ‹è¯•" class="test-image">
        </div>
        <div id="aws-test-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•4: æ­£å¸¸å›¾ç‰‡åŠ è½½</h2>
        <p>æµ‹è¯•æ­£å¸¸å›¾ç‰‡æ˜¯å¦èƒ½æ­£ç¡®åŠ è½½</p>
        <div class="image-wrapper">
            <img src="" data-src="https://picsum.photos/400/300" alt="æ­£å¸¸å›¾ç‰‡æµ‹è¯•" class="test-image">
        </div>
        <div id="normal-test-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿä¿®å¤åçš„imageHandleræ¨¡å—
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        loadImageWithAnimation(img);
                        observer.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '100px 0px',
            threshold: 0.1
        });

        async function loadImageWithAnimation(img) {
            try {
                const wrapper = img.closest('.image-wrapper');
                if (wrapper) {
                    wrapper.classList.add('loading');
                }

                const preloadImg = new Image();
                preloadImg.crossOrigin = "anonymous";
                
                preloadImg.onload = () => {
                    displayImage(img, preloadImg.src, wrapper);
                    logTest(getTestId(img), `âœ“ å›¾ç‰‡åŠ è½½æˆåŠŸ: ${img.dataset.src}`, 'success');
                };

                preloadImg.onerror = () => {
                    handleImageError(img, wrapper, preloadImg.src);
                };

                preloadImg.src = img.dataset.src;

            } catch (error) {
                console.error('Error loading image:', error);
                handleImageError(img, img.closest('.image-wrapper'), img.dataset.src);
            }
        }

        function displayImage(img, src, wrapper) {
            img.src = src;
            img.classList.add('loaded');
            
            if (wrapper) {
                wrapper.classList.remove('loading');
                wrapper.classList.add('loaded');
            }
        }

        function handleImageError(img, wrapper, failedSrc = '') {
            const originalSrc = img.dataset.src || failedSrc;
            console.error('Failed to load image:', originalSrc);
            
            const isHeicFormat = originalSrc.toLowerCase().includes('.heic');
            const isNotionImage = originalSrc.includes('prod-files-secure.s3.us-west-2.amazonaws.com');
            
            if (wrapper) {
                wrapper.classList.remove('loading');
                
                let errorMessage = 'Failed to load image';
                let showRetry = true;
                
                if (isHeicFormat) {
                    errorMessage = 'HEIC format not supported by browser';
                    showRetry = false;
                    logTest('heic', `âœ“ HEICæ ¼å¼é”™è¯¯æ­£ç¡®è¯†åˆ«`, 'success');
                } else if (isNotionImage && originalSrc.includes('X-Amz-Expires')) {
                    errorMessage = 'Image link expired - please refresh the page';
                    showRetry = false;
                    logTest('aws', `âœ“ AWSè¿‡æœŸé“¾æ¥æ­£ç¡®è¯†åˆ«`, 'success');
                } else {
                    logTest(getTestId(img), `âœ— å›¾ç‰‡åŠ è½½å¤±è´¥: ${originalSrc}`, 'error');
                }
                
                wrapper.innerHTML = `
                    <div class="image-error" style="text-align: center; padding: 20px; background: #f5f5f5; border: 2px dashed #ccc; border-radius: 8px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“·</div>
                        <div style="color: #666; margin-bottom: 10px;">${errorMessage}</div>
                        ${isHeicFormat ? `
                            <div style="font-size: 0.875rem; color: #888; margin-bottom: 10px;">
                                HEIC images are not supported in web browsers.<br>
                                Please convert to JPG, PNG, or WebP format.
                            </div>
                        ` : ''}
                        ${showRetry ? `
                            <button onclick="retryImageLoad(this)" 
                                    style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ”„ Retry
                            </button>
                        ` : isNotionImage ? `
                            <button onclick="window.location.reload()" 
                                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ”„ Refresh Page
                            </button>
                        ` : ''}
                        <div style="font-size: 0.75rem; color: #999; margin-top: 10px; word-break: break-all;">${originalSrc}</div>
                    </div>
                `;
            }
        }

        function getTestId(img) {
            if (img.dataset.src.includes('.heic')) return 'heic';
            if (img.dataset.src.includes('X-Amz-Expires')) return 'aws';
            if (img.dataset.src.includes('picsum.photos')) return 'normal';
            return 'unknown';
        }

        function logTest(testId, message, type = 'info') {
            const logElement = document.getElementById(`${testId}-test-log`);
            if (logElement) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `\n[${timestamp}] ${message}`;
                logElement.className = `log ${type}`;
            }
        }

        // æµ‹è¯•1: éªŒè¯imageObserveræ­£å¸¸å·¥ä½œ
        function testImageObserver() {
            try {
                const images = document.querySelectorAll('img[data-src]');
                logTest('observer', `æ‰¾åˆ° ${images.length} ä¸ªéœ€è¦è§‚å¯Ÿçš„å›¾ç‰‡`, 'info');
                
                // ä¿®å¤åçš„æ­£ç¡®æ–¹å¼
                images.forEach(img => {
                    imageObserver.observe(img);
                });
                
                logTest('observer', `âœ“ imageObserver.observe() è°ƒç”¨æˆåŠŸ`, 'success');
                logTest('observer', `âœ“ å·²ä¸º ${images.length} ä¸ªå›¾ç‰‡è®¾ç½®æ‡’åŠ è½½è§‚å¯Ÿ`, 'success');
                
                // æµ‹è¯•é”™è¯¯çš„è°ƒç”¨æ–¹å¼ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
                try {
                    imageObserver.init();
                    logTest('observer', `âœ— imageObserver.init() ä¸åº”è¯¥æˆåŠŸ`, 'error');
                } catch (error) {
                    logTest('observer', `âœ“ imageObserver.init() æ­£ç¡®æŠ›å‡ºé”™è¯¯: ${error.message}`, 'success');
                }
                
            } catch (error) {
                logTest('observer', `âœ— imageObserveræµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å…¨å±€é‡è¯•å‡½æ•°
        window.retryImageLoad = function(button) {
            const wrapper = button.closest('.image-wrapper');
            if (!wrapper) return;
            
            const img = wrapper.querySelector('img');
            if (!img || !img.dataset.src) return;
            
            wrapper.classList.remove('loaded');
            wrapper.classList.add('loading');
            wrapper.innerHTML = '<img src="" alt="" style="opacity: 0;">';
            
            const newImg = wrapper.querySelector('img');
            newImg.dataset.src = img.dataset.src;
            newImg.alt = img.alt;
            
            loadImageWithAnimation(newImg);
        };

        // å¯åŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            logTest('observer', 'å¼€å§‹æµ‹è¯•imageObserveråŠŸèƒ½...', 'info');
            testImageObserver();
            
            // ç»™å›¾ç‰‡ä¸€äº›æ—¶é—´åŠ è½½
            setTimeout(() => {
                logTest('heic', 'å¼€å§‹æµ‹è¯•HEICæ ¼å¼é”™è¯¯å¤„ç†...', 'info');
                logTest('aws', 'å¼€å§‹æµ‹è¯•AWSè¿‡æœŸé“¾æ¥å¤„ç†...', 'info');
                logTest('normal', 'å¼€å§‹æµ‹è¯•æ­£å¸¸å›¾ç‰‡åŠ è½½...', 'info');
            }, 1000);
        });
    </script>
</body>
</html> 