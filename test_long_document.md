# 超长文档加载修复说明

## 最新问题诊断 (2024-01-01)

通过API测试发现根本问题：**Vercel函数超时限制**

### 问题分析
1. **FUNCTION_INVOCATION_TIMEOUT**: Vercel免费版限制函数执行时间为10秒
2. **API超时**: 当批次大小过大时（如50个块），Notion API处理时间超过10秒
3. **前端未正确处理**: 遇到超时HTML错误页面时，JSON解析失败导致加载停止

### 修复策略

#### 前端优化 (notionRenderer.js)
1. **减少批次大小**: 从20-50减少到10-20个块，避免超时
2. **动态批次调整**: 连续超时时自动减少批次大小（最小3个块）
3. **超时检测**: 识别Vercel的FUNCTION_INVOCATION_TIMEOUT错误
4. **错误页面处理**: 检测HTML错误页面，避免JSON解析失败
5. **智能重试**: 超时错误使用更长的重试延迟（2秒 vs 1秒）
6. **增加延迟**: 基础延迟从800ms增加到1200ms适应Vercel冷启动

#### 后端优化 (main.py)
1. **减少默认limit**: 从20减少到15个块
2. **降低max_limit**: 从100减少到20个块
3. **减少page_size**: 从100减少到30个块
4. **缩短超时**: 从30秒减少到8秒，留2秒缓冲避免Vercel超时
5. **保持错误处理**: 返回部分内容而非完全失败

#### 连续超时处理
- 第1次超时: 批次大小减半
- 第2次超时: 批次大小再减半
- 第3次超时: 使用最小批次大小（3-5个块）
- 重试时: 进一步减少批次大小

#### 测试验证
```bash
# 小批次测试（应该成功）
curl "https://notion-img.vercel.app/api/page/.../more?cursor=...&limit=10"

# 大批次测试（可能超时）
curl "https://notion-img.vercel.app/api/page/.../more?cursor=...&limit=50"
```

## 使用说明

1. **初始加载**: 仍然加载前15个块保证快速显示
2. **渐进加载**: 后台以小批次（10-20块）加载剩余内容
3. **自动调整**: 遇到超时自动减少批次大小并重试
4. **容错机制**: 即使部分批次失败，其他内容正常显示
5. **用户体验**: 提供详细的错误信息和加载状态

## 预期效果

- ✅ 避免Vercel 10秒超时限制
- ✅ 支持超长文档（数千个块）
- ✅ 自适应批次大小
- ✅ 智能错误恢复
- ✅ 保持内容顺序正确

## 部署验证

修复后应该能够：
1. 成功加载超长文档的完整内容
2. 在遇到超时时自动调整策略继续加载
3. 提供清晰的进度指示和错误信息
4. 保持良好的用户体验 